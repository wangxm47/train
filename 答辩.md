# 答辩

1. 问好, 自我介绍

    各位评审好, 我是web-ui组的实习生王显淼,我本次参与答辩的课题是**UI通用优化工具**

2. 介绍答辩内容 

    我今天的答辩内容主要有四部分,第一部分会简单介绍课题需求,第二部分主要讲述课题设计思路和具体实现, 第三部分主要展示课题成果,最后是一些遇到的问题和反思

3. 介绍课题需求
    
    第一部分会介绍课题背景,然后针对课题内容进行分析.

4. 课题背景

    目前维护的UI代码时间跨度大，机型功能类似，会有很多代码直接在复用基础上添加功能, 例如SU具有一些基础组件,但是一些项目在复用SU框架的时候并没有使用部分组件，导致过多冗余，造成页面加载慢。并且各套代码使用不同构建，在原先基础上做修改过于繁杂。故而需要提供一个独立的工具可以供每套代码做精简工作。
    因为这个工具是提供给开发人员使用,所以除了主要的冗余清除功能外,还需要生成报告以供后续调试.

5.  课题内容分析

    根据分析, 目前需要进行代码冗余清理的主要是采用SU框架进行开发的应用, 早期的SU1.0框架和现在使用的SU2.0框架虽然原理相同,但是SU2.0在SU1.0的基础上采用了更加精细的封装,因此需要对SU1.0与SU2.0分别进行冗余代码的清除. SU的冗余代码主要包括三部分: CSS, JS, 文案. 

    UI代码情况复杂, 部分代码时间久远, 项目趋于稳定, 只想要清理CSS和文案,或者想要清理冗余的widget组件不想清理其他JS代码. 这些情况都代表工具需要具有丰富的自定义配置功能,针对这些需求进行分析,大致得出以下配置项: 1. 自定义冗余清理文件 2. 自定义筛选文件 3. 忽略文件项 4. 压缩文件项等

    通过之前的分析,可以知道主要进行冗余清理的代码为SU框架的项目代码, 虽然项目间具有差异, 但是SU框架的使用方法较为固定, 使得代码清理可行, 再搭配自定义配置项和完善的报告, 能够保障冗余清理后的项目可还原和稳定运行, 因此课题可行.

6. 冗余对象分析

    冗余清除的对象之前有提到是JS,CSS和文案.
    其中JS因为SU1.0与2.0的差别需要分别进行优化,SU1.0优化对象主要为widget组件,而2.0较为复杂需要优化widget,module,model等.
    CSS的冗余部分主要是未使用的CSS代码和无效代码
    文案在SU中以object的形式表示,所以未使用的属性即为冗余文案.

7. 设计思路

    根据之前分析, 将代码优化分为四个步骤, 分别是文件读取,关键词提取,冗余清除和文件与log生成,其中关键词提取是最重要的部分.
    关键词是一个冗余对象的标识符,如widget组件,module模块的名字,CSS中的选择器,文案的属性名, 对象的调用也会使用关键词,因此找出未使用过的关键词,就找到了冗余对象.
    因此我们提取对象定义时的关键词(即定义关键词)和调用时使用的关键词(即筛选关键词)两相对比就可以轻松发现定义未使用的关键词,即冗余关键词,将这部分关键词代表的冗余对象清除就达到了代码优化的目的.

8. CSS冗余清除

    CSS的冗余清除按照思路分为四步，第一步文件读取主要是获取自定设置项里的文件路径，并将文件内容读取方便后续处理．

    第二步是最关键的一步，这一步的难点在于筛选关键词的读取，筛选关键词的读取要分为两部分，一部分是从HTML文件中提取，另一部分是从JS文件中提取，难点在于从JS中提取.
    SU中有许多代码是将HTML字符串拼装起来插入DOM节点,并且还有拼装字符串生成类名为DOM节点添加,因此我们需要提取所有的字符串,采用的方法是利用Uglify-JS生成AST(抽象语法树),遍历AST结点,找寻类型为字符串的结点,将字符串提取出来,除此之外,还需要将这些字符串进行筛选,例如利用正则表达式提取出HTML字符串中的类名,标签和id, 这些字符串可能只是用于拼装的部分,为了保证不会误删,将这些字符串转化为代表类名选择器,id选择器的正则表达式,在筛选时只要CSS选择器匹配表达式就认为其为有效选择器,这样做虽然会导致筛选率降低,但能尽量保证不会误删,是项目进行代码优化后能够稳定运行.

    接下来,就是利用CSS插件库将CSS代码转化为AST,提取出选择器,与之前提取的筛选关键词去对比筛选,剔除无效选择器和无效代码从而优化代码.

    最后就是将优化后的代码输出并生成log.

9. JS冗余清除

    JS冗余清除与CSS冗余清除除关键词提取外大致相同.
    在提取关键词时,最开始依旧尝试将JS代码转化为AST去提取,但是难度较大,不好操作,因此最后选择采用正则表达式去提取关键词, 编写正则表达式比较耗时, 因为一旦有一个字符错误就会导致正则表达式出错,不会得到正确的结果.
    在提取定义关键词时,我将文件路径与关键词组合为object作为元素添加到关键词数组,这样做是因为在项目中许多widget,module等都是单文件定义,在剔除冗余时,我们得到冗余关键词,此时只需要剔除对应文件就可以了,而少部分非单文件定义的元素,会使用正则表达式去提取冗余代码进行删除.

10. 文案冗余清除

    文案冗余清除的关键词又与前两种冗余清除方式不同.
    因为文案的定义与调用方式都是以属性定义与调用的方式去进行,因此会在转化的AST中寻找属性定义和属性调用作为关键词.
    而在实际使用文案时,有将整个object调用遍历的形式使用,因此还会在提取筛选关键词时使用正则表达式进行辅助,满足匹配代表采用了遍历属性的形式使用文案,因此会将object里的所有文案添加到筛选关键词数组中.